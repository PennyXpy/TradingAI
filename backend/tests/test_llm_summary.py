# backend/tests/test_llm_summary.py
from backend.tools.llm_client import count_tokens
from backend.tools.text_preprocessing import preprocess_text
from backend.tools.llm_client import summarize_single_chunk
from textwrap import shorten

test_article = """
    **STOCK OF THE DAY: [Why This Big Retailer Is Dodging Tariff Trouble](https://www.investors.com/research/ibd-stock-of-the-day/costco-stock-tariffs-chart/)**\n\n[![Follow IBDâ€™s Market Exposure Signals](https://www.investors.com/wp-content/uploads/2025/04/bc-marketexposure-750x114-1.png)](https://get.investors.com/ibd/market-exposure/?src=A00205&trackingCode=ab474cb2&utm_source=SFMC&utm_medium=Email&utm_campaign=MARKET+EXPOSURE&utm_id=ME041625&utm_content=IBDD)\n\nNew to Investors.com?\n\n[Start here!](https://shop.investors.com/offer/splashresponsive.aspx?id=gettingstarted&src=A00332A&intcode=GetStarted_HP;)\n\n* * *\n\n**Tesla** ( [TSLA](https://research.investors.com/quote.aspx?symbol=TSLA)) reports first-quarter earnings and revenue late on Tuesday, but with many analysts and investors already expecting poor results, attention will likely be more focused on the outlook for the long-awaited more affordable EV model, impacts from President Donald Trump\'s tariffs, an update on the planned June 2025 rollout of robotaxis in Austin and when Chief Executive Elon Musk will move away from his role in the Trump White House.\n\nBy the numbers, analysts expect quarterly profit to decline 9% to 41 cents per share with sales of $21.34 billion, running nearly flat compared to a year ago, according to FactSet. 
    However, the sharp consensus projects a slight decline.\n\nThe most recent analyst notes have first-quarter EPS ranging from 30-to-51 cents, with a sharp consensus pointing to a small sales decline. Tesla Q1 consensus earnings projections have come down more than 40% since the end of 2024.\n\nâ†‘X\n\nMore Videos\n\n0 seconds of 0 secondsVolume 0%\n\nPress shift question mark to access a list of keyboard shortcuts\n\nKeyboard ShortcutsEnabledDisabled\n\nShortcuts Open/Close/ or ?\n\nPlay/PauseSPACE\n\nIncrease Volumeâ†‘\n\nDecrease Volumeâ†“\n\nSeek Forwardâ†’\n\nSeek Backwardâ†\n\nCaptions On/Offc\n\nFullscreen/Exit Fullscreenf\n\nMute/Unmutem\n\nDecrease Caption Size-\n\nIncrease Caption Size\\+ or =\n\nSeek %0-9\n\nNext Up\n\nCrypto Strategic Reserve Talk From Trump Boosts Bitcoin Despite These Hurdles\n\n03:20\n\nSubtitle Settings\n\nOffEnglish\n\nFont Color\n\nWhite\n\nFont Opacity\n\n100%\n\nFont Size\n\n100%\n\nFont Family\n\nsans-serif\n\nCharacter Edge\n\nNone\n\nEdge Color\n\nBlack\n\nBackground Color\n\nBlack\n\nBackground Opacity\n\n75%\n\nWindow Color\n\nBlack\n\nWindow Opacity\n\n0%\n\nReset\n\nWhiteBlackRedGreenBlueYellowMagentaCyan\n\n100%75%50%25%\n\n200%175%150%125%100%75%50%\n\nArialCourierGeorgiaImpactLucida ConsoleTahomaTimes New RomanTrebuchet MSVerdana\n\nNoneRaisedDepressedUniformDrop Shadow\n\nWhiteBlackRedGreenBlueYellowMagentaCyan\n\nWhiteBlackRedGreenBlueYellowMagentaCyan\n\n100%75%50%25%0%\n\nWhiteBlackRedGreenBlueYellowMagentaCyan\n\n100%75%50%25%0%\n\n0.5x1x1.25x1.5x2x\n\nLive\n\n00:00\n\n00:00\n\n00:00\n\nThis video file cannot be played.(Error\xa0Code:\xa0232011)\n\n[How China\'s BYD Is Beating Tesla As Musk Faces Challenges](https://www.investors.com/ibd-videos/videos/how-chinas-byd-is-beating-tesla-as-musk-faces-challenges)\n\n[See All Videos](https://www.investors.com/ibd-videos)\n\nNOW PLAYINGHow China\'s BYD Is Beating Tesla As Musk Faces Challenges\n\nPiper Sandler analysts wrote last past week that Tesla\'s Q1 financials "will likely underwhelm" and that its gross margin is "probably trending near multiyear lows."\n\nWith this sentiment heading into earnings, analysts and investors will be looking for commentary on Tesla\'s future plans. Here are the top questions heading into Tuesday\'s earnings release and conference call.\n\nTSLA fell as low 222.79 intraday, closing down 5.8% to 227.50 during Monday\'s [stock market action](https://www.investors.com/category/market-trend/stock-market-today/). Shares ended last week down 4.3% to 241.37.\n\n## Robotaxi June Rollout Still On?\n\nMusk said on the Q4 call that Tesla will begin paid robotaxi rides in Austin, Texas, this June. However, he\'s said for years that Tesla would achieve self-driving "this year" or "next year."\n\nFor many investors and analysts, the robotaxi and true autonomous driving are the major catalysts for Tesla stock.\n\nThe latest version of full self-driving, or FSD, does appear to show a modest boost increase in miles per critical disengagement. But the unofficial FSD Community Tracker, endorsed by Musk several times, signals it\'s a long way from robotaxi status.\n\nAt the late 2024 [Tesla robotaxi event](https://www.investors.com/news/tesla-stock-robotaxi-event-disappoints-for-these-reasons/), Musk showed off the two-seat Cybercab, with no steering wheel.\n\nMusk expects the Cybercab price tag will be below $30,000, with production starting "before 2027." However, Cybercab obviously needs true self driving to be sold.\n\nMeanwhile, Reuters, citing one source with direct knowledge of the situation, reported this week that Tesla [suspended plans to ship parts](https://www.investors.com/news/tesla-stock-trump-tariffs-robotaxi-production-delay/) from China for the Cybercab and Semi electric trucks after Trump raised tariffs on Chinese goods to 145%.\n\nThe EV giant was set to pay the costs when Trump imposed the 34% tariff on China-made goods but could not do so when the tariffs were increased, according to Reuters. Now, the disruption could muddle the production timeline for the Cybercab.\n\nThe Cybercab is supposed to use the "unboxed" manufacturing system, a modular approach that aims to cut costs. But it\'s unclear if Tesla has figured out how to make this revolutionary process work.\n\nInvestors will be looking to commentary on whether the robotaxi, or Cybercab, timeline for June is still on track.\n\n* * *\n\n[**Tesla Rises On Robotaxi Hopes Despite Earnings Miss. Elon Musk Sees \'Epic\' 2026.**](https://www.investors.com/news/tesla-stock-earnings-q4-elon-musk/)\n\n* * *\n\nRead more on Tesla\'s [third-quarter](https://www.investors.com/news/tesla-stock-earnings-q3-elon-musk/) results, [second-quarter earnings](https://www.investors.com/news/tesla-stock-earnings-q2-tsla-rally/) or on the company\'s [first-quarter report](https://www.investors.com/news/tesla-earnings-fall-tesla-stock-surges/).\n\n## Affordable EV Coming. What Will It Be?\n\nAnother potential catalyst for Tesla stock is the long-hinted at new "affordable" model. Tesla has a stagnant vehicle lineup and an affordable new vehicle could bring in more customers.\n\nThe Cybertruck, Tesla\'s first new passenger EV in the past five years, appears to be a bust. Deliveries seemed slow yet again in Q1, even with the Cybertruck becoming eligible for the $7,500 tax credit.\n\nOverall sales of the Model S, X and Cybertruck were just 12,881 in Q1.\n\nThe company announced on March 20 the recall of 46,096 Cybertruck vehicles to fix an exterior panel that could detach while driving, according to the U.S. National Highway Traffic Safety Administration. Tesla sold 38,965 Cybertrucks in 2024, according to Cox Automotive estimates.\n\nThe EV giant in 2024 ditched its long-touted plans for a "next-generation" EV. Tesla now plans "affordable vehicles," using existing production lines.\n\nLate Friday, Reuters reported that Tesla will delay its upcoming "affordable" EV by at least three months. Tesla had said it planned production of a lower-cost vehicle by midyear, but various reports suggested it would come in late 2025 or 2026. The latest report said production will start in the U.S., followed by China and Europe.\n\nOther recent reports suggest that the first "affordable" EV will be a stripped-down Model Y, perhaps slightly smaller. Tesla stock bulls have hoped for at least a new form factor, 
    such as a hatchback. The reports suggested the cheaper Model Y could come in late 2025 or perhaps 2026.\n\nMeanwhile, Tesla began deliveries of a refreshed Model Y in China on Feb. 26, with the U.S. and Europe following in early March.\n\nThe new Model Y has a clearly different front and back, with a light bar similar to that of the Cybertruck, as well as many other EVs. Tesla has started selling a cheaper Model Y variant, which doesn\'t include FSD. But wait times remain low.\n\n## Vehicle Delivery Outlook?\n\nMusk on the Q4 earnings call appeared to signal 2025 could be a middling year for the EV giant, with only slight vehicle sales growth, even as he continues to sound bullish on the possibility for incredible things to come in 2026, 2027 and 2028. That was a step down from the Q3 2024 earnings call, when he forecast 20%-30% delivery growth this year.\n\nTesla in early April announced worse-than-expected Q1 vehicle deliveries as Musk\'s political persona and work with the Trump administration seem to have damaged the brand.\n\n* * *\n\n**[Tesla Vs. BYD: Tesla Earnings Due With Focus On This. Fast-Charging Rival Also On Tap.](https://www.investors.com/news/tesla-vs-byd-ev-sales-robotaxis/)**\n\n* * *\n\n[The company delivered 336,681 EVs](https://www.investors.com/news/tesla-stock-market-tesla-deliveries/) in Q1, down 13% vs. a year earlier and the lowest since Q2 2022. They fell 32.1% vs. Q4\'s record 495,570 EVs. The bright spot is Tesla China, where sales appeared to edge higher vs. a year earlier, but those tend to be lower margin. U.S. and European sales have tumbled on Musk\'s brand woes.\n\nTesla also deployed 10.4 gigawatt-hours of energy storage products in Q1, down slightly vs. Q4\'s record 11 GWh but up 156% vs. a year earlier.\n\nA recent YouGov and Yahoo News survey of 1,677 U.S. adults between March 20 and March 24 showed that 67% of respondents would not consider buying or leasing a Tesla vehicle. Thirty-seven percent of those polled said Elon Musk was the "whole/part of the reason why."\n\nConsensus currently has 2025 vehicle deliveries increasing 3% to 1.84 million vehicles, but several recent analyst notes predict around 1.7 million units sold, which would represent a decrease from the 1.79 million in 2024.\n\n## Tesla Trump Tariffs Impact\n\nTrump\'s trade policy has been front and center in recent weeks. While Tesla, due to its supply chains, is thought to be among the least impacted by the Trump tariffs, the company will not be completely unscathed.\n\nInvestors will be looking to see if the EV giant gives any details around Trump tariffs impact and plans to mitigate effects on its business, specifically when it comes to its batteries.\n\nTesla traditionally has not mass-produced its own batteries. For lithium-ion batteries, its joint venture partner Japan\'s Panasonic makes the cells and Tesla packages them. Tesla also buys lithium-ion batteries from South Korea\'s LG.\n\nThe company\'s battery storage business is also exposed to China, buying lithium iron phosphate (LFP) batteries from China\'s CATL as well as some LFP batteries from **BYD** ( [BYDDF](https://research.investors.com/quote.aspx?symbol=BYDDF)).\n\nTrump currently has a 145% tariff on China-made products coming into the U.S.\n\n* * *\n\n**[Still A Trump Tariff Market; Tesla Headlines Key Earnings](https://www.investors.com/market-trend/stock-market-today/dow-jones-futures-trump-tariff-tesla-google-t-mobile-earnings/)**\n\n* * *\n\n## When Will Musk Step Away From Trump White House\n\nMusk\'s high-profile role in the Trump administration heading up the Department of Government Efficiency, or DOGE â€” along with his political comments regarding the U.S., U.K., Germany and Ukraine â€” appear to be further eroding Tesla\'s brand in the U.S. and Europe, especially with groups most likely to buy an EV.\n\nMusk reportedly will leave the Trump administration soon but it\'s unclear exactly when that will be. An update on the Tesla chief\'s plans and how much time he\'s committing to Tesla could come up on the earnings call.\n\nWedbush Securities analyst Dan Ives, a longtime Tesla bull, wrote on Sunday that Musk "needs to leave government" and be a full-time CEO for Tesla. Ives added that Musk on the Q1 earnings call must "lay out the timeline/hard facts" around the rollout of autonomous vehicles and robotics over the next 6-12 months. Ives is also looking for clearly answers around when the "new lower cost vehicle" will hit the production line.\n\n"We also would expect Musk to address his role in the Trump Administration and will be asked about if he plans to stay in an advisory role for the White House," Ives said.\n\n"We view this as a fork in the road time: if Musk leaves the White House there will be permanent brand damage. â€¦ But Tesla will have its most important asset and strategic thinker back as full time CEO to drive the vision and the long term story will not be altered. If Musk chooses to stay with the Trump White House it could change the future of Tesla/brand damage will grow. â€¦ A huge week ahead for Musk, Tesla, and investors," Ives wrote.\n\nIves previously [cut his Tesla stock target price](https://www.investors.com/news/tesla-stock-price-target-slashed-43-trump-tariffs-apple-pt-sliced-23/) by around 40%, writing that Trump\'s tariffs and an Elon Musk "brand crisis" have created a "perfect storm" for the EV giant.\n\nIves estimates that Tesla has lost or destroyed at least 10% of its future customer base and "this could be conservative." In Europe, the figure could be 20% or more "all self-inflicted by Musk."\n\nThere have also been ongoing demonstrations at Tesla dealerships and stories of Tesla vehicles being vandalized.\n\n## Tesla Stock Action\n\nTesla stock fell 4.3% to 241.37 last week. The stock is down 51% from its 488.54 peak on Dec. 18. However, shares have held above its March lows of 214.25. Still, Tesla stock remains down 40% so far in 2025 and is one of the worst performers in the S&P 500.\n\nTSLA: $227.50 13.87 (5.75%) - Tesla - Investors.com\n\n110%\n\n_5-minute interval_\n\n83 msec (SVG)\n\nOne moment. 
    Retrieving data...\n\n200400Price64,900,000MayAprMarFebJanDecNovOctSepAugJulJunMayAprMarFebJanDecNovOctSepAug021804210721072410271329150118042006230926122814311703190522082309261229150117032006220825112814\n\n04/21/2025 (Market Close)\n\nConcerns about Tesla\'s growth and robotaxis as well as fears about Musk\'s focus and impact on Tesla\'s brand image have taken a toll on TSLA stock.\n\n* * *\n\n[**Trump\'s Auto Tariffs Are Here. What Is Next For The U.S. Auto Industry?**](https://www.investors.com/research/industry-snapshot/trump-tariffs-auto-tariffs-what-it-means-for-auto-industry/)\n\n* * *\n\nSince Trump announced the 25% auto tariffs, the 32 stocks in the [IBD Auto Manufacturers industry group](https://marketsurge.investors.com/) collectively dropped around 16%. The group has declined 39% in 2025. That puts the industry at 101 out of the 197 sectors tracked by IBD, with No. 1 the strongest and 197 the weakest sector.\n\nTesla stock has a 21-day [average true range](https://www.investors.com/how-to-invest/investors-corner/average-true-range-growth-stocks-analysis/) of 8.97%. The ATR metric is available on IBD\'s [MarketSurge charting tool](https://marketsurge.investors.com/). It gauges the characteristic breadth of a stock\'s behavior. Stocks that tend to make large jumps or dives in daily action, the kind that can trigger sell rules and shake investors out of a stock, have a high ATR. Stocks that tend to make more incremental moves have lower ATRs.\n\nIn the current market, IBD suggests stocks with ATRs of 3% or below.\n\nTesla stock\xa0has a 69 [Composite Rating](https://www.investors.com/how-to-invest/investors-corner/stocks-to-buy-and-watch-ibd-composite-rating-top-growth-stocks/) out of a best-possible 99. Shares also have a 62 [Relative Strength Rating](https://www.investors.com/how-to-invest/investors-corner/relative-strength-rating-stock-chart-analysis-helps-pick-outstanding-growth-stocks/) and an 84 [EPS Rating](https://www.investors.com/how-to-invest/investors-corner/eps-rating-is-key-to-picking-great-stocks/).
    """


def test_full_preprocessing_and_summary():
    print("\nðŸ§¾ Starting full summarization test...")

    total_tokens = count_tokens(test_article)
    print(f"ðŸ§® Total tokens in article: {total_tokens}\n")

    chunks = preprocess_text(test_article, max_tokens=3000, token_based=True)

    print(f"ðŸ§© Total raw chunks generated: {len(chunks)}\n")

    filtered_chunks = [c for c in chunks if count_tokens(c.strip()) > 5]
    print(f"âœ… Chunks retained after filtering: {len(filtered_chunks)}\n")

    for i, chunk in enumerate(chunks):
        token_len = count_tokens(chunk)
        preview = shorten(chunk.replace("\n", " "), width=300, placeholder="...")
        print(f"--- Raw Chunk {i+1} ---")
        print(f"Token count: {token_len}")
        print(f"Preview: {preview}\n")

    mini_summaries = []
    for i, chunk in enumerate(filtered_chunks):
        print(f"ðŸ“„ Summarizing Chunk {i+1}/{len(filtered_chunks)}...")
        summary = summarize_single_chunk(chunk)
        print(f"âœ… Summary {i+1}:")
        print(summary + "\n")
        mini_summaries.append(summary)

    combined_summary = summarize_single_chunk("\n\n".join(mini_summaries))

    print("\nðŸ“¢ Final Overall Summary:")
    print(combined_summary)

if __name__ == "__main__":
    test_full_preprocessing_and_summary()